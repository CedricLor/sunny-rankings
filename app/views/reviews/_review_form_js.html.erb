<script>
//<![CDATA[

$(document).ready( function() {
  /* hide the legal warning on load */
  $("#legalWarning").addClass( "hidden" );
  /* hide the inputs */
  $(".rating-input").addClass( "hidden" );
  /* create the visual handles */
  $(".rating-input").parent().each( function () {
    var steps = ["mad","bad","fine","happy","veryhappy"];
    var line_of_icons = $("<div class='rating-icons-line'></div>").css({
          display: 'block'
        });
    var i = 0;
    $(steps).each( function () {
      var icon = $("<div class='rating-icons'></div>");
      icon.addClass(steps[i]);
      line_of_icons.append(icon);
      i++;
    });
    $(this).append(line_of_icons);
  });
});

/* change the icon background color on click */
$(window).load( function() {
  $('.rating-icons').on( "click", function() {
    /* remove all background classes */
    $( this ).parent().find( '.rating-icons').removeClass("grey-background-icon").removeClass("green-background-icon").removeClass("red-background-icon").removeClass("yellow-background-icon");
  });
  $('.rating-icons:first-child').on( "click", function() {
    $( this ).addClass("red-background-icon");
  });
  $('.rating-icons:nth-child(2)').on( "click", function() {
    $( this ).addClass("yellow-background-icon");
  });
  $('.rating-icons:nth-child(3)').on( "click", function() {
    $( this ).addClass("grey-background-icon");
  });
  $('.rating-icons:nth-child(4)').on( "click", function() {
    $( this ).addClass("yellow-background-icon");
  });
  $('.rating-icons:last-child').on( "click", function() {
    $( this ).addClass("green-background-icon");
  });
})

/* set value of select when clicking on a smiley */
$(window).load( function() {
  $('.rating-icons').on( "click", function() {
    $(this).parents('.form-group').find('select').val($(this).index() + 1);
  });
});

/* This displays the legal warning if rating is very low or if rating is very low on wage discrimination
or harassment */
$(window).load( function() {
  const num_of_issues = {
          1: "a serious issue ",
          2: "serious issues "
        },
        type_of_issue = {
          3: "of wage discrimination. ",
          4: "of sexual harassment. ",
          7: "of wage discrimination and sexual harassment. "
        },
        second_sentence = {
          1: "this is a serious matter. ",
          2: "these are serious matters. "
        }

  function legal_warning_builder(i, x) {
    legal_warning_sentence = "You are about to report " + num_of_issues[i] + type_of_issue[x] + "Please note that " + second_sentence[i] + "Please review our terms of use of service before doing so.";
    return legal_warning_sentence;
  }

  var i = 0,
      x = 0;

  $('.rating-icons').on( "click", function() {
    serious_harassment = $(".rating-icons-line").eq(4).find('.rating-icons.mad');
    serious_discrimination = $(".rating-icons-line").eq(3).find('.rating-icons.mad');

    if ( $(serious_harassment).hasClass('red-background-icon') &&
         $(serious_discrimination).hasClass('red-background-icon') ) {
      i = 2;
      x = 7;
      $( "#legalWarning" ).text(legal_warning_builder(i, x)).removeClass("hidden");
    } else if ( $(serious_harassment).hasClass('red-background-icon') ) {
      i = 1;
      x = 4;
      $( "#legalWarning" ).text(legal_warning_builder(i, x)).removeClass("hidden");
    } else if ( $(serious_discrimination).hasClass('red-background-icon') ) {
      i = 1;
      x = 3;
      $( "#legalWarning" ).text(legal_warning_builder(i, x)).removeClass("hidden");
    } else {
      $( "#legalWarning" ).text("").addClass("hidden");
    }
  });
});

// This is the form checker
// On Document Fully Ready
$(window).load( function() {
  /* Start by disabling the vote button on load*/
  $('#voteButton').prop("disabled",true)

  const regexes = {
    "zip_code": /^(F-)?((2[A|B])|[0-9]{2})[0-9]{3}$/,
    "email": /^[-a-z0-9~!$%^&*_=+}{\'?]+(\.[-a-z0-9~!$%^&*_=+}{\'?]+)*@([a-z0-9_][-a-z0-9_]*(\.[-a-z0-9_]+)*\.(aero|arpa|biz|com|coop|edu|gov|info|int|mil|museum|name|net|org|pro|travel|mobi|[a-z][a-z])|([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}))(:[0-9]{1,5})?$/i,
    "mobile_phone": /^06[0-9]{8}$/,
    "person_or_city_name": /^[A-Z][a-zA-Z\-]+$/,
    "other": /\w+/
  };

  function myField(DOMSelectedObject) {
    this.textValue = DOMSelectedObject.val();
    this.attrId = DOMSelectedObject.attr("id");
    /* Quick fix to make it work when the email field is not tagged with id="email" */
    if ( this.attrId == "review_temporary_email" ) { this.attrId = "email" }
    this.validity = false;
    this.updateCSS = function() {
      ( this.validity == false ) ?
      DOMSelectedObject.closest('.form-group').addClass("has-error") :
      DOMSelectedObject.closest('.form-group').removeClass("has-error");
    };
    this.regexSelector = function(id) {
      var regex;
      const ids = {
        zip_code() { isNotName() },
        email() { isNotName()  },
        mobile_phone() { isNotName() },
        first_name() { isName() },
        last_name() { isName() },
        city() { isName() },
        other() { regex = regexes['other'] }
      };
      function isNotName() { regex = regexes[id] };
      function isName() { regex = regexes.person_or_city_name };
      (ids[id] || ids['other'] )()
      return regex;
    };
    this.regex = this.regexSelector(this.attrId);
  };

  myField.prototype.updateValidity = function() {
    ( this.textValue.match(this.regex) ) ? this.validity = true : this.validity = false;
  };

  myChecker = new function() {
    function myFieldsLoader() {
      var myFields = {};
      /* Quick fix to avoid that the form control controls other form fields than the field of
      the review form (such as the search form, for instance) */
      // This selector should select all the fields that need to be validated
      $('#review_temporary_email').each(function() {
        myFields[$(this).attr("id")] = new myField($(this));
        $(this).val("");
      });
      return myFields;
    };
    this.myFields = myFieldsLoader();
    this.are_all_valid = false;
    this.switch_are_all_valid = function() {
      var none_are_invalid = true;
      $.each(this.myFields, function( key, value ) {
        if (value.validity == false) { none_are_invalid = false };
      });
      this.are_all_valid = none_are_invalid;
    };
    this.validityControl = function(id, newValue) {
      this.myFields[id].textValue = newValue;
      this.myFields[id].updateValidity();
      this.myFields[id].updateCSS();
      this.switch_are_all_valid();
    };
  };

  function enable_button() {
    ($('#review_confirmed_t_and_c').is(':checked')) && myChecker.are_all_valid ?
      $('#voteButton').prop("disabled",false) :
      $('#voteButton').prop("disabled",true);
  };

  // Attach a handler triggered when the check-box is clicked
  $('#review_confirmed_t_and_c').click(function() {
    if (!( $('#review_confirmed_t_and_c').is(':checked') )) { alert("Please agree to the terms of services!"); }
    enable_button();
  });
  // Attach a handler triggered when the focus goes out of a form field
  // This selector should select all the fields that need to be validated
  $('#review_temporary_email').focusout(function() {
    myChecker.validityControl($(this).attr("id"), $(this).val());
    enable_button();
  });
});

//]]>
</script>